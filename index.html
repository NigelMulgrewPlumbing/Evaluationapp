alert('Data exported for ServiceTitan import. Contact your administrator to complete the integration.'); } } // Photo Handling Functions function handlePhotoUpload(sectionId, input) { const files = input.files; if (!files || files.length === 0) return; // Initialize photo data for this section if not exists if (!photoData[sectionId]) { photoData[sectionId] = []; } const previewContainer = document.getElementById(`${sectionId}-preview`); for (let file of files) { if (file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = function(e) { const photoId = `${sectionId}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`; // Store photo data photoData[sectionId].push({ id: photoId, data: e.target.result, name: file.name, timestamp: new Date().toISOString(), section: sectionId }); // Create preview element const photoDiv = document.createElement('div'); photoDiv.className = 'photo-preview'; photoDiv.id = photoId; const img = document.createElement('img'); img.src = e.target.result; img.onclick = () => openPhotoModal(e.target.result); const removeBtn = document.createElement('button'); removeBtn.className = 'photo-remove'; removeBtn.innerHTML = '×'; removeBtn.onclick = () => removePhoto(sectionId, photoId); const caption = document.createElement('div'); caption.className = 'photo-caption'; caption.textContent = file.name; photoDiv.appendChild(img); photoDiv.appendChild(removeBtn); photoDiv.appendChild(caption); previewContainer.appendChild(photoDiv); }; reader.readAsDataURL(file); } } // Clear the input for re-use input.value = ''; } // Remove photo function removePhoto(sectionId, photoId) { // Remove from data if (photoData[sectionId]) { photoData[sectionId] = photoData[sectionId].filter(photo => photo.id !== photoId); } // Remove from DOM const photoElement = document.getElementById(photoId); if (photoElement) { photoElement.remove(); } } // Open photo modal function openPhotoModal(imageSrc) { const modal = document.getElementById('photoModal'); const modalImg = document.getElementById('modalImage'); modalImg.src = imageSrc; modal.classList.add('active'); } // Close photo modal function closePhotoModal(event) { if (event.target.id === 'photoModal' || event.target.className === 'photo-modal-close') { const modal = document.getElementById('photoModal'); modal.classList.remove('active'); } } // Get photo notes function getPhotoNotes(sectionId) { const notesElement = document.getElementById(`${sectionId}-notes`); return notesElement ? notesElement.value : ''; } // Update save data to include photos function saveDataWithPhotos() { const data = { jobInfo: { jobNumber: document.getElementById('jobNumber').value, jobDate: document.getElementById('jobDate').value, technician: document.getElementById('technician').value }, evaluationData: evaluationData, photoData: photoData, photoNotes: {}, recommendations: document.getElementById('recommendations').value, timestamp: new Date().toISOString() }; // Collect all photo notes document.querySelectorAll('.photo-notes').forEach(textarea => { if (textarea.id && textarea.value) { const sectionId = textarea.id.replace('-notes', ''); data.photoNotes[sectionId] = textarea.value; } }); // For demo purposes, we'll download as JSON const dataStr = JSON.stringify(data, null, 2); const dataBlob = new Blob([dataStr], {type: 'application/json'}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `plumbing-evaluation-${data.jobInfo.jobNumber || 'draft'}-${Date.now()}.json`; link.click(); alert('Evaluation data with photos saved successfully!'); } // Override the original saveData function function saveData() { saveDataWithPhotos(); } // Update PDF generation to include photo count function generatePDFWithPhotos() { const content = generatePDFContent(); // Add photo summary to PDF let photoSummary = '\n\n
PHOTO DOCUMENTATION
\n'; photoSummary += '
\n'; let totalPhotos = 0; for (const section in photoData) { if (photoData[section] && photoData[section].length > 0) { const sectionName = section.replace(/-/g, ' ').toUpperCase(); photoSummary += `
${sectionName}: ${photoData[section].length} photos attached
\n`; totalPhotos += photoData[section].length; } } if (totalPhotos === 0) { photoSummary += '
No photos attached to this evaluation.
\n'; } else { photoSummary += `
Total Photos: ${totalPhotos}
\n`; } photoSummary += '
\n'; // Insert photo summary before recommendations const updatedContent = content.replace('
', photoSummary + '
'); const printWindow = window.open('', '_blank'); printWindow.document.write(updatedContent); printWindow.document.close(); setTimeout(() => { printWindow.print(); }, 500); } // Override the original generatePDF function function generatePDF() { generatePDFWithPhotos(); } // Update email report to include photo information function emailReportWithPhotos() { const jobNumber = document.getElementById('jobNumber').value || 'N/A'; const jobDate = document.getElementById('jobDate').value || new Date().toLocaleDateString(); const technician = document.getElementById('technician').value || 'N/A'; const recommendations = document.getElementById('recommendations').value || 'None'; // Get summary stats const totalChecked = document.getElementById('totalChecked').textContent; const totalPassed = document.getElementById('totalPassed').textContent; const totalWarnings = document.getElementById('totalWarnings').textContent; const totalFailed = document.getElementById('totalFailed').textContent; // Count photos let totalPhotos = 0; let photoSections = []; for (const section in photoData) { if (photoData[section] && photoData[section].length > 0) { totalPhotos += photoData[section].length; photoSections.push(`${section}: ${photoData[section].length} photos`); } } // Create email body let emailBody = `Plumbing Evaluation Report\n`; emailBody += `============================\n\n`; emailBody += `Job Number: ${jobNumber}\n`; emailBody += `Date: ${jobDate}\n`; emailBody += `Technician: ${technician}\n\n`; emailBody += `SUMMARY\n`; emailBody += `-------\n`; emailBody += `Total Items Checked: ${totalChecked}\n`; emailBody += `Passed: ${totalPassed}\n`; emailBody += `Warnings: ${totalWarnings}\n`; emailBody += `Failed: ${totalFailed}\n\n`; if (totalPhotos > 0) { emailBody += `PHOTO DOCUMENTATION\n`; emailBody += `-------------------\n`; emailBody += `Total Photos: ${totalPhotos}\n`; emailBody += photoSections.join('\n') + '\n\n'; } emailBody += `RECOMMENDATIONS\n`; emailBody += `---------------\n`; emailBody += `${recommendations}\n\n`; emailBody += `Note: Full evaluation with photos attached as data file.\n`; // Create mailto link const subject = `Plumbing Evaluation Report - Job #${jobNumber}`; const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`; window.location.href = mailtoLink; alert('Email client opened. Photos are included in the saved data file.\n\n' + 'For automated emails with embedded photos, integrate with:\n' + '• SendGrid API\n' + '• Mailgun API\n' + '• ServiceTitan messaging system'); } // Override the original emailReport function function emailReport() { emailReportWithPhotos(); } // Update clear all to include photos function clearAllWithPhotos() { if (confirm('Are you sure you want to clear all evaluation data including photos?')) { evaluationData = {}; photoData = {}; // Clear all status buttons document.querySelectorAll('.status-btn').forEach(btn => { btn.classList.remove('pass', 'fail', 'warning', 'na'); }); // Clear all form inputs document.getElementById('jobNumber').value = ''; document.getElementById('jobDate').value = ''; document.getElementById('technician').value = ''; document.getElementById('recommendations').value = ''; // Clear all photo previews document.querySelectorAll('.photo-preview-container').forEach(container => { container.innerHTML = ''; }); // Clear all photo notes document.querySelectorAll('.photo-notes').forEach(textarea => { textarea.value = ''; }); updateSummary(); } } // Override the original clearAll function function clearAll() { clearAllWithPhotos(); } // Photo Handling Functions function handlePhotoUpload(sectionId, input) { const files = input.files; if (!files || files.length === 0) return; // Initialize photo data for this section if not exists if (!photoData[sectionId]) { photoData[sectionId] = []; } const previewContainer = document.getElementById(`${sectionId}-preview`); for (let file of files) { if (file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = function(e) { const photoId = `${sectionId}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`; // Store photo data photoData[sectionId].push({ id: photoId, data: e.target.result, name: file.name, timestamp: new Date().toISOString(), section: sectionId }); // Create preview element const photoDiv = document.createElement('div'); photoDiv.className = 'photo-preview'; photoDiv.id = photoId; const img = document.createElement('img'); img.src = e.target.result; img.onclick = () => openPhotoModal(e.target.result); const removeBtn = document.createElement('button'); removeBtn.className = 'photo-remove'; removeBtn.innerHTML = '×'; removeBtn.onclick = () => removePhoto(sectionId, photoId); const caption = document.createElement('div'); caption.className = 'photo-caption'; caption.textContent = file.name; photoDiv.appendChild(img); photoDiv.appendChild(removeBtn); photoDiv.appendChild(caption); previewContainer.appendChild(photoDiv); }; reader.readAsDataURL(file); }