<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Plumbing Eval">
    <title>Plumbing Evaluation - Nigel Mulgrew Plumbing</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1024px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .storage-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 10px 20px;
            border-radius: 4px;
            font-size: 13px;
            display: none;
        }
        
        .storage-warning.show {
            display: block;
        }
        
        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-tab {
            padding: 15px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 14px;
            white-space: nowrap;
            color: #495057;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        
        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }
        
        .tab-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
        }
        
        .tab-delete-btn:hover {
            background: #c82333;
        }
        
        .add-room-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin: 10px 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-room-btn:active {
            background: #218838;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            margin: -20px -20px 20px -20px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rename-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .rename-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .item-number {
            background: #667eea;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .item-title {
            flex: 1;
            font-weight: 500;
            font-size: 15px;
            min-width: 200px;
        }
        
        .condition-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .condition-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .condition-btn.good {
            border-color: #28a745;
            color: #28a745;
        }
        
        .condition-btn.good.active {
            background: #28a745;
            color: white;
        }
        
        .condition-btn.fair {
            border-color: #ffc107;
            color: #ffc107;
        }
        
        .condition-btn.fair.active {
            background: #ffc107;
            color: #000;
        }
        
        .condition-btn.poor {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .condition-btn.poor.active {
            background: #dc3545;
            color: white;
        }
        
        .item-notes {
            margin-top: 10px;
        }
        
        .item-notes textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .photo-section {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .photo-upload {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .photo-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .photo-btn:active {
            background: #5568d3;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .photo-item {
            position: relative;
            padding-top: 100%;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .photo-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        
        .action-buttons {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 15px 20px;
            border-top: 2px solid #dee2e6;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:active {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:active {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:active {
            background: #c82333;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .summary-card h3 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            color: #6c757d;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1001;
        }
        
        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            color: #333;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1001;
        }
        
        .modal-prev {
            left: 20px;
        }
        
        .modal-next {
            right: 20px;
        }
        
        @media (max-width: 768px) {
            .item-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .condition-group {
                width: 100%;
                margin-top: 10px;
            }
            
            .condition-btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 Plumbing Evaluation Form</h1>
            <p>Nigel Mulgrew Plumbing, Inc. | Professional Assessment Tool</p>
        </div>
        
        <div class="storage-warning" id="storageWarning">
            ⚠️ <strong>Storage Notice:</strong> Data is saved temporarily. Please export or email your report before closing this app!
        </div>
        
        <div class="nav-tabs" id="navTabs"></div>
        
        <div id="tabsContainer"></div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="savePDF()">📄 Save PDF</button>
            <button class="btn btn-success" onclick="emailPDF()">📧 Email PDF</button>
            <button class="btn btn-danger" onclick="clearAllData()">🗑️ Clear All</button>
        </div>
    </div>
    
    <div class="modal" id="photoModal">
        <button class="modal-close" onclick="closePhotoModal()">×</button>
        <button class="modal-nav modal-prev" onclick="changePhoto(-1)">‹</button>
        <div class="modal-content">
            <img id="modalImage" src="" alt="Photo">
        </div>
        <button class="modal-nav modal-next" onclick="changePhoto(1)">›</button>
    </div>

    <script>
        const sectionTemplates = {
            bathrooms: {
                title: 'Bathroom',
                emoji: '🚽',
                canAddMultiple: true,
                items: [
                    'Toilet flush', 'Toilet leaks', 'Toilet wobbles', 'Toilet wax ring',
                    'Sink faucet operation', 'Sink drain', 'Sink leaks', 'Sink trap',
                    'Shower/tub faucet', 'Shower/tub drain', 'Shower/tub leaks', 'Shower head',
                    'Tub spout', 'Tub caulking', 'Floor drain', 'Exhaust fan',
                    'Water pressure', 'Hot water temp', 'Angle stops', 'Supply lines',
                    'Tile/grout condition', 'Caulking', 'Water damage', 'Ventilation',
                    'Accessibility', 'Fixtures age', 'Overall bathroom'
                ]
            },
            kitchen: {
                title: 'Kitchen',
                emoji: '🍳',
                canAddMultiple: true,
                items: [
                    'Kitchen sink faucet', 'Kitchen sink drain', 'Kitchen sink leaks',
                    'Garbage disposal', 'Dishwasher connection', 'Dishwasher drain',
                    'Ice maker line', 'Pot filler', 'Kitchen sprayer',
                    'Angle stops', 'Supply lines', 'Drain pipes',
                    'Air gap', 'Soap dispenser', 'Water filter',
                    'Caulking', 'Overall kitchen'
                ]
            },
            laundry: {
                title: 'Laundry',
                emoji: '🧺',
                canAddMultiple: false,
                items: [
                    'Washer hot valve', 'Washer cold valve', 'Washer drain',
                    'Washer box', 'Hoses condition', 'Laundry sink faucet',
                    'Laundry sink drain', 'Floor drain', 'Venting',
                    'Water pressure', 'Shut-off valves', 'Overall laundry'
                ]
            },
            basement: {
                title: 'Basement/Utility',
                emoji: '🔧',
                canAddMultiple: false,
                items: [
                    'Main shut-off valve', 'Pressure regulator', 'Water heater',
                    'Water heater age', 'Water heater venting', 'TPR valve',
                    'Drain pan', 'Expansion tank', 'Gas lines',
                    'Sump pump', 'Ejector pump', 'Floor drains',
                    'Cleanouts', 'Pipe insulation', 'Pipe condition',
                    'Foundation leaks', 'Sewer line', 'Overall basement'
                ]
            },
            garage: {
                title: 'Garage/Yard',
                emoji: '🏡',
                canAddMultiple: false,
                items: [
                    'Hose bibs', 'Hose bib leaks', 'Sprinkler system',
                    'Sprinkler valves', 'Backflow preventer', 'Yard drains',
                    'Sewer cleanout', 'Water meter', 'Main line',
                    'Overall exterior'
                ]
            },
            general: {
                title: 'General',
                emoji: '📋',
                canAddMultiple: false,
                items: [
                    'Water quality', 'Water odor', 'Water color',
                    'Overall pressure', 'Pipe material', 'Visible corrosion',
                    'Signs of leaks', 'Water stains', 'Mold/mildew',
                    'Code compliance', 'Safety issues', 'Overall assessment'
                ]
            },
            other: {
                title: 'Other',
                emoji: '📝',
                canAddMultiple: false,
                items: [
                    'Additional item 1', 'Additional item 2', 'Additional item 3',
                    'Additional item 4', 'Additional item 5', 'Additional notes'
                ]
            }
        };

        let currentTab = 'bathrooms-0';
        let evaluationData = {};
        let roomInstances = {};
        let currentPhotoViewing = null;
        let storageAvailable = false;

        function checkStorage() {
            try {
                const testKey = '__storage_test__';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                storageAvailable = true;
                return true;
            } catch (e) {
                storageAvailable = false;
                document.getElementById('storageWarning').classList.add('show');
                console.warn('localStorage not available:', e);
                return false;
            }
        }

        function initApp() {
            checkStorage();
            
            // Initialize with one instance of each room type
            Object.keys(sectionTemplates).forEach(type => {
                if (!roomInstances[type]) {
                    roomInstances[type] = [];
                }
                if (roomInstances[type].length === 0) {
                    addRoom(type, false);
                }
            });

            if (storageAvailable) {
                loadData();
            }

            renderTabs();
            renderContent();
        }

        function generateRoomId(type) {
            const count = roomInstances[type].length;
            return `${type}-${count}`;
        }

        function addRoom(type, shouldSave = true) {
            const template = sectionTemplates[type];
            const roomId = generateRoomId(type);
            
            const defaultName = template.canAddMultiple 
                ? `${template.title} ${roomInstances[type].length + 1}`
                : template.title;

            roomInstances[type].push({
                id: roomId,
                name: defaultName,
                type: type
            });

            evaluationData[roomId] = {
                type: type,
                name: defaultName,
                items: {},
                photos: []
            };

            template.items.forEach((item, index) => {
                evaluationData[roomId].items[index] = {
                    title: item,
                    condition: null,
                    notes: ''
                };
            });

            currentTab = roomId;

            if (shouldSave) {
                saveDataDebounced();
                renderTabs();
                renderContent();
            }
        }

        function deleteRoom(roomId) {
            const roomData = evaluationData[roomId];
            if (!roomData) return;

            const type = roomData.type;
            const template = sectionTemplates[type];

            if (!template.canAddMultiple) {
                alert(`Cannot delete ${template.title} - only one allowed.`);
                return;
            }

            if (!confirm(`Delete ${roomData.name}?`)) return;

            // Remove from instances
            roomInstances[type] = roomInstances[type].filter(r => r.id !== roomId);
            
            // Delete data
            delete evaluationData[roomId];

            // Switch to another tab
            if (currentTab === roomId) {
                const allRoomIds = getAllRoomIds();
                currentTab = allRoomIds[0] || 'summary';
            }

            saveDataDebounced();
            renderTabs();
            renderContent();
        }

        function renameRoom(roomId) {
            const roomData = evaluationData[roomId];
            if (!roomData) return;

            const newName = prompt('Enter new name:', roomData.name);
            if (newName && newName.trim()) {
                roomData.name = newName.trim();
                
                // Update in instances
                const type = roomData.type;
                const instance = roomInstances[type].find(r => r.id === roomId);
                if (instance) {
                    instance.name = newName.trim();
                }

                saveDataDebounced();
                renderTabs();
                renderContent();
            }
        }

        function getAllRoomIds() {
            const ids = [];
            Object.keys(roomInstances).forEach(type => {
                roomInstances[type].forEach(room => {
                    ids.push(room.id);
                });
            });
            return ids;
        }

        function renderTabs() {
            const navTabs = document.getElementById('navTabs');
            navTabs.innerHTML = '';

            // Add tabs for each room instance
            Object.keys(sectionTemplates).forEach(type => {
                const template = sectionTemplates[type];
                
                roomInstances[type].forEach(room => {
                    const button = document.createElement('button');
                    button.className = `nav-tab ${room.id === currentTab ? 'active' : ''}`;
                    button.onclick = () => switchTab(room.id);
                    
                    const label = document.createElement('span');
                    label.textContent = `${template.emoji} ${room.name}`;
                    button.appendChild(label);

                    if (template.canAddMultiple && roomInstances[type].length > 1) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'tab-delete-btn';
                        deleteBtn.textContent = '×';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            deleteRoom(room.id);
                        };
                        button.appendChild(deleteBtn);
                    }

                    navTabs.appendChild(button);
                });

                // Add "+" button for types that can have multiples
                if (template.canAddMultiple) {
                    const addBtn = document.createElement('button');
                    addBtn.className = 'add-room-btn';
                    addBtn.innerHTML = `+ Add ${template.title}`;
                    addBtn.onclick = () => addRoom(type);
                    navTabs.appendChild(addBtn);
                }
            });

            // Add summary tab
            const summaryBtn = document.createElement('button');
            summaryBtn.className = `nav-tab ${currentTab === 'summary' ? 'active' : ''}`;
            summaryBtn.textContent = '📊 Summary';
            summaryBtn.onclick = () => switchTab('summary');
            navTabs.appendChild(summaryBtn);
        }

        function switchTab(tab) {
            currentTab = tab;
            renderTabs();
            renderContent();
        }

        function renderContent() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';

            if (currentTab === 'summary') {
                container.innerHTML = renderSummary();
                return;
            }

            const roomData = evaluationData[currentTab];
            if (!roomData) return;

            const template = sectionTemplates[roomData.type];

            let html = `
                <div class="tab-content active">
                    <div class="section-header">
                        <span>${template.emoji} ${roomData.name}</span>
                        <button class="rename-btn" onclick="renameRoom('${currentTab}')">✏️ Rename</button>
                    </div>
            `;

            template.items.forEach((item, index) => {
                const itemData = roomData.items[index];
                html += `
                    <div class="item">
                        <div class="item-header">
                            <div class="item-number">${index + 1}</div>
                            <div class="item-title">${item}</div>
                            <div class="condition-group">
                                <button class="condition-btn good ${itemData.condition === 'good' ? 'active' : ''}" 
                                        onclick="setCondition('${currentTab}', ${index}, 'good')">✓ Good</button>
                                <button class="condition-btn fair ${itemData.condition === 'fair' ? 'active' : ''}" 
                                        onclick="setCondition('${currentTab}', ${index}, 'fair')">! Fair</button>
                                <button class="condition-btn poor ${itemData.condition === 'poor' ? 'active' : ''}" 
                                        onclick="setCondition('${currentTab}', ${index}, 'poor')">✗ Poor</button>
                            </div>
                        </div>
                        <div class="item-notes">
                            <textarea placeholder="Add notes..." 
                                      onchange="setNotes('${currentTab}', ${index}, this.value)"
                                      onblur="saveDataDebounced()">${itemData.notes}</textarea>
                        </div>
                    </div>
                `;
            });

            html += `
                    <div class="photo-section">
                        <div class="photo-upload">
                            <input type="file" id="photoInput_${currentTab}" accept="image/*" 
                                   capture="environment" style="display:none" 
                                   onchange="handlePhotoUpload('${currentTab}', event)" multiple>
                            <button class="photo-btn" onclick="document.getElementById('photoInput_${currentTab}').click()">
                                📷 Add Photos
                            </button>
                            <span style="font-size:12px;color:#6c757d;">${roomData.photos.length} photos</span>
                        </div>
                        <div class="photo-grid" id="photoGrid_${currentTab}">
                            ${renderPhotos(currentTab)}
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function setCondition(roomId, index, condition) {
            evaluationData[roomId].items[index].condition = condition;
            saveDataDebounced();
            renderContent();
        }

        function setNotes(roomId, index, notes) {
            evaluationData[roomId].items[index].notes = notes;
        }

        let saveTimeout;
        function saveDataDebounced() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 500);
        }

        function saveData() {
            if (!storageAvailable) {
                console.warn('Storage not available, data not saved');
                return;
            }
            
            try {
                const dataToSave = {
                    version: 2,
                    timestamp: new Date().toISOString(),
                    roomInstances: roomInstances,
                    data: evaluationData
                };
                localStorage.setItem('plumbingEval', JSON.stringify(dataToSave));
            } catch (e) {
                console.error('Error saving data:', e);
                document.getElementById('storageWarning').classList.add('show');
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('plumbingEval');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (confirm('Found saved data from ' + new Date(parsed.timestamp).toLocaleString() + '. Restore it?')) {
                        if (parsed.version === 2) {
                            roomInstances = parsed.roomInstances;
                            evaluationData = parsed.data;
                        } else {
                            // Migrate old data
                            alert('Converting old data format...');
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        async function handlePhotoUpload(roomId, event) {
            const files = Array.from(event.target.files);
            
            for (const file of files) {
                try {
                    const compressed = await compressImage(file);
                    evaluationData[roomId].photos.push(compressed);
                } catch (e) {
                    console.error('Error processing photo:', e);
                    alert('Error processing photo. It may be too large.');
                }
            }
            
            saveDataDebounced();
            renderContent();
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 1200;
                        
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function renderPhotos(roomId) {
            const photos = evaluationData[roomId].photos;
            return photos.map((photo, index) => `
                <div class="photo-item" onclick="viewPhoto('${roomId}', ${index})">
                    <img src="${photo}" alt="Photo ${index + 1}">
                    <button class="photo-delete" onclick="event.stopPropagation(); deletePhoto('${roomId}', ${index})">×</button>
                </div>
            `).join('');
        }

        function deletePhoto(roomId, index) {
            if (confirm('Delete this photo?')) {
                evaluationData[roomId].photos.splice(index, 1);
                saveDataDebounced();
                renderContent();
            }
        }

        function viewPhoto(roomId, index) {
            currentPhotoViewing = { roomId, index };
            const modal = document.getElementById('photoModal');
            const img = document.getElementById('modalImage');
            img.src = evaluationData[roomId].photos[index];
            modal.classList.add('active');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('active');
            currentPhotoViewing = null;
        }

        function changePhoto(direction) {
            if (!currentPhotoViewing) return;
            
            const { roomId, index } = currentPhotoViewing;
            const photos = evaluationData[roomId].photos;
            let newIndex = index + direction;
            
            if (newIndex < 0) newIndex = photos.length - 1;
            if (newIndex >= photos.length) newIndex = 0;
            
            viewPhoto(roomId, newIndex);
        }

        function renderSummary() {
            let totalItems = 0;
            let goodCount = 0;
            let fairCount = 0;
            let poorCount = 0;
            let notEvaluated = 0;
            let totalPhotos = 0;

            Object.values(evaluationData).forEach(roomData => {
                const items = roomData.items;
                Object.values(items).forEach(item => {
                    totalItems++;
                    if (item.condition === 'good') goodCount++;
                    else if (item.condition === 'fair') fairCount++;
                    else if (item.condition === 'poor') poorCount++;
                    else notEvaluated++;
                });
                totalPhotos += roomData.photos.length;
            });

            return `
                <div class="tab-content active">
                    <div class="section-header">📊 Evaluation Summary</div>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <h3>${totalItems}</h3>
                            <p>Total Items</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="color:#28a745">${goodCount}</h3>
                            <p>Good Condition</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="color:#ffc107">${fairCount}</h3>
                            <p>Fair Condition</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="color:#dc3545">${poorCount}</h3>
                            <p>Poor Condition</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="color:#6c757d">${notEvaluated}</h3>
                            <p>Not Evaluated</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="color:#667eea">${totalPhotos}</h3>
                            <p>Photos Taken</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function saveJSON() {
            const dataStr = JSON.stringify({
                roomInstances,
                evaluationData
            }, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `plumbing-eval-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        async function savePDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pageWidth - (2 * margin);
            let yPosition = margin;

            // Helper function to check if we need a new page
            function checkNewPage(heightNeeded) {
                if (yPosition + heightNeeded > pageHeight - margin) {
                    pdf.addPage();
                    yPosition = margin;
                    return true;
                }
                return false;
            }

            // Header
            pdf.setFillColor(44, 62, 80);
            pdf.rect(0, 0, pageWidth, 35, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(22);
            pdf.text('Plumbing Evaluation Report', pageWidth / 2, 15, { align: 'center' });
            pdf.setFontSize(10);
            pdf.text('Nigel Mulgrew Plumbing, Inc.', pageWidth / 2, 23, { align: 'center' });
            pdf.text(new Date().toLocaleString(), pageWidth / 2, 29, { align: 'center' });
            
            yPosition = 45;

            // Summary Section
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('Summary', margin, yPosition);
            yPosition += 10;

            let totalItems = 0;
            let goodCount = 0;
            let fairCount = 0;
            let poorCount = 0;
            let notEvaluated = 0;
            let totalPhotos = 0;

            Object.values(evaluationData).forEach(roomData => {
                Object.values(roomData.items).forEach(item => {
                    totalItems++;
                    if (item.condition === 'good') goodCount++;
                    else if (item.condition === 'fair') fairCount++;
                    else if (item.condition === 'poor') poorCount++;
                    else notEvaluated++;
                });
                totalPhotos += roomData.photos.length;
            });

            pdf.setFont(undefined, 'normal');
            pdf.setFontSize(11);
            pdf.text(`Total Items Evaluated: ${totalItems}`, margin, yPosition);
            yPosition += 6;
            pdf.setTextColor(40, 167, 69);
            pdf.text(`Good Condition: ${goodCount}`, margin, yPosition);
            yPosition += 6;
            pdf.setTextColor(255, 193, 7);
            pdf.text(`Fair Condition: ${fairCount}`, margin, yPosition);
            yPosition += 6;
            pdf.setTextColor(220, 53, 69);
            pdf.text(`Poor Condition: ${poorCount}`, margin, yPosition);
            yPosition += 6;
            pdf.setTextColor(108, 117, 125);
            pdf.text(`Not Evaluated: ${notEvaluated}`, margin, yPosition);
            yPosition += 6;
            pdf.setTextColor(102, 126, 234);
            pdf.text(`Total Photos: ${totalPhotos}`, margin, yPosition);
            yPosition += 12;

            // Issues Found Section
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            checkNewPage(20);
            pdf.text('Issues Found', margin, yPosition);
            yPosition += 10;

            let issuesFound = [];
            Object.values(evaluationData).forEach(roomData => {
                Object.entries(roomData.items).forEach(([index, item]) => {
                    if (item.condition === 'fair' || item.condition === 'poor') {
                        issuesFound.push({
                            room: roomData.name,
                            item: item.title,
                            condition: item.condition,
                            notes: item.notes
                        });
                    }
                });
            });

            if (issuesFound.length === 0) {
                pdf.setFont(undefined, 'normal');
                pdf.setFontSize(11);
                pdf.setTextColor(40, 167, 69);
                pdf.text('No significant issues found!', margin, yPosition);
                yPosition += 10;
            } else {
                pdf.setFont(undefined, 'normal');
                pdf.setFontSize(10);
                
                issuesFound.forEach((issue, index) => {
                    checkNewPage(25);
                    
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont(undefined, 'bold');
                    const issueText = `${index + 1}. ${issue.room} - ${issue.item}`;
                    pdf.text(issueText, margin, yPosition);
                    yPosition += 5;
                    
                    pdf.setFont(undefined, 'normal');
                    if (issue.condition === 'poor') {
                        pdf.setTextColor(220, 53, 69);
                    } else {
                        pdf.setTextColor(255, 193, 7);
                    }
                    pdf.text(`Condition: ${issue.condition.toUpperCase()}`, margin + 5, yPosition);
                    yPosition += 5;
                    
                    if (issue.notes) {
                        pdf.setTextColor(60, 60, 60);
                        const lines = pdf.splitTextToSize(`Notes: ${issue.notes}`, contentWidth - 10);
                        lines.forEach(line => {
                            checkNewPage(5);
                            pdf.text(line, margin + 5, yPosition);
                            yPosition += 5;
                        });
                    }
                    
                    yPosition += 3;
                });
            }

            yPosition += 10;

            // Detailed Evaluation by Room
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            checkNewPage(20);
            pdf.text('Detailed Evaluation', margin, yPosition);
            yPosition += 10;

            Object.values(evaluationData).forEach(roomData => {
                checkNewPage(20);
                
                // Room header
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(102, 126, 234);
                pdf.text(roomData.name, margin, yPosition);
                yPosition += 8;

                // Room items
                pdf.setFontSize(9);
                pdf.setFont(undefined, 'normal');
                
                Object.entries(roomData.items).forEach(([index, item]) => {
                    checkNewPage(10);
                    
                    let conditionColor = [108, 117, 125]; // gray for not evaluated
                    let conditionText = 'Not Evaluated';
                    
                    if (item.condition === 'good') {
                        conditionColor = [40, 167, 69];
                        conditionText = 'GOOD';
                    } else if (item.condition === 'fair') {
                        conditionColor = [255, 193, 7];
                        conditionText = 'FAIR';
                    } else if (item.condition === 'poor') {
                        conditionColor = [220, 53, 69];
                        conditionText = 'POOR';
                    }
                    
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`${parseInt(index) + 1}. ${item.title}`, margin + 3, yPosition);
                    
                    pdf.setTextColor(...conditionColor);
                    pdf.text(conditionText, margin + 100, yPosition);
                    yPosition += 4;
                    
                    if (item.notes) {
                        pdf.setTextColor(60, 60, 60);
                        const lines = pdf.splitTextToSize(item.notes, contentWidth - 10);
                        lines.forEach(line => {
                            checkNewPage(4);
                            pdf.text(line, margin + 8, yPosition);
                            yPosition += 4;
                        });
                    }
                    
                    yPosition += 2;
                });
                
                yPosition += 5;
            });

            // Add photos section indicator
            if (totalPhotos > 0) {
                checkNewPage(20);
                pdf.setFontSize(14);
                pdf.setFont(undefined, 'bold');
                pdf.setTextColor(102, 126, 234);
                pdf.text('Photos', margin, yPosition);
                yPosition += 8;
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.setTextColor(60, 60, 60);
                pdf.text(`${totalPhotos} photos were taken during this evaluation.`, margin, yPosition);
                yPosition += 6;
                pdf.text('Photos are compressed and included on the following pages.', margin, yPosition);
                yPosition += 10;

                // Add photos
                for (const roomData of Object.values(evaluationData)) {
                    if (roomData.photos.length > 0) {
                        checkNewPage(20);
                        pdf.setFontSize(12);
                        pdf.setFont(undefined, 'bold');
                        pdf.setTextColor(102, 126, 234);
                        pdf.text(`${roomData.name} Photos`, margin, yPosition);
                        yPosition += 8;

                        for (let i = 0; i < roomData.photos.length; i++) {
                            const photo = roomData.photos[i];
                            
                            // Check if we need a new page for the photo
                            const photoHeight = 100;
                            if (checkNewPage(photoHeight + 10)) {
                                // New page was added
                            }
                            
                            try {
                                const imgWidth = contentWidth;
                                const imgHeight = 100;
                                pdf.addImage(photo, 'JPEG', margin, yPosition, imgWidth, imgHeight);
                                yPosition += imgHeight + 5;
                                
                                pdf.setFontSize(9);
                                pdf.setFont(undefined, 'normal');
                                pdf.setTextColor(108, 117, 125);
                                pdf.text(`Photo ${i + 1} of ${roomData.photos.length}`, margin, yPosition);
                                yPosition += 10;
                            } catch (e) {
                                console.error('Error adding photo to PDF:', e);
                            }
                        }
                    }
                }
            }

            // Save the PDF
            const fileName = `Plumbing_Evaluation_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(fileName);
            
            alert('PDF saved successfully!');
        }

        async function emailPDF() {
            alert('Generating PDF... This may take a moment.');
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pageWidth - (2 * margin);
            let yPosition = margin;

            function checkNewPage(heightNeeded) {
                if (yPosition + heightNeeded > pageHeight - margin) {
                    pdf.addPage();
                    yPosition = margin;
                    return true;
                }
                return false;
            }

            // Generate same PDF content
            pdf.setFillColor(44, 62, 80);
            pdf.rect(0, 0, pageWidth, 35, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(22);
            pdf.text('Plumbing Evaluation Report', pageWidth / 2, 15, { align: 'center' });
            pdf.setFontSize(10);
            pdf.text('Nigel Mulgrew Plumbing, Inc.', pageWidth / 2, 23, { align: 'center' });
            pdf.text(new Date().toLocaleString(), pageWidth / 2, 29, { align: 'center' });
            
            yPosition = 45;

            // Summary
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('Summary', margin, yPosition);
            yPosition += 10;

            let totalItems = 0;
            let goodCount = 0;
            let fairCount = 0;
            let poorCount = 0;

            Object.values(evaluationData).forEach(roomData => {
                Object.values(roomData.items).forEach(item => {
                    totalItems++;
                    if (item.condition === 'good') goodCount++;
                    else if (item.condition === 'fair') fairCount++;
                    else if (item.condition === 'poor') poorCount++;
                });
            });

            pdf.setFont(undefined, 'normal');
            pdf.setFontSize(11);
            pdf.text(`Total Items: ${totalItems}`, margin, yPosition);
            yPosition += 6;
            pdf.setTextColor(40, 167, 69);
            pdf.text(`Good: ${goodCount}`, margin, yPosition);
            yPosition += 6;
            pdf.setTextColor(255, 193, 7);
            pdf.text(`Fair: ${fairCount}`, margin, yPosition);
            yPosition += 6;
            pdf.setTextColor(220, 53, 69);
            pdf.text(`Poor: ${poorCount}`, margin, yPosition);
            yPosition += 12;

            // Issues
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('Issues Found', margin, yPosition);
            yPosition += 10;

            let issuesFound = [];
            Object.values(evaluationData).forEach(roomData => {
                Object.entries(roomData.items).forEach(([index, item]) => {
                    if (item.condition === 'fair' || item.condition === 'poor') {
                        issuesFound.push({
                            room: roomData.name,
                            item: item.title,
                            condition: item.condition,
                            notes: item.notes
                        });
                    }
                });
            });

            if (issuesFound.length === 0) {
                pdf.setFont(undefined, 'normal');
                pdf.setFontSize(11);
                pdf.setTextColor(40, 167, 69);
                pdf.text('No significant issues found!', margin, yPosition);
            } else {
                pdf.setFont(undefined, 'normal');
                pdf.setFontSize(10);
                
                issuesFound.forEach((issue, index) => {
                    checkNewPage(20);
                    
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(`${index + 1}. ${issue.room} - ${issue.item}`, margin, yPosition);
                    yPosition += 5;
                    
                    pdf.setFont(undefined, 'normal');
                    if (issue.condition === 'poor') {
                        pdf.setTextColor(220, 53, 69);
                    } else {
                        pdf.setTextColor(255, 193, 7);
                    }
                    pdf.text(`Condition: ${issue.condition.toUpperCase()}`, margin + 5, yPosition);
                    yPosition += 5;
                    
                    if (issue.notes) {
                        pdf.setTextColor(60, 60, 60);
                        const lines = pdf.splitTextToSize(`Notes: ${issue.notes}`, contentWidth - 10);
                        lines.forEach(line => {
                            checkNewPage(5);
                            pdf.text(line, margin + 5, yPosition);
                            yPosition += 5;
                        });
                    }
                    
                    yPosition += 3;
                });
            }

            // Convert PDF to base64 for attachment
            const pdfData = pdf.output('dataurlstring');
            
            // Create mailto with instructions
            const subject = 'Plumbing Evaluation Report - ' + new Date().toLocaleDateString();
            const body = encodeURIComponent(
                'Please find attached the plumbing evaluation report.\n\n' +
                'Summary:\n' +
                `Total Items: ${totalItems}\n` +
                `Good: ${goodCount}\n` +
                `Fair: ${fairCount}\n` +
                `Poor: ${poorCount}\n\n` +
                'Note: PDF has been saved to your device. Please attach it manually to this email.\n\n' +
                'Best regards,\n' +
                'Nigel Mulgrew Plumbing, Inc.'
            );
            
            // Save PDF first
            const fileName = `Plumbing_Evaluation_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(fileName);
            
            // Then open email
            setTimeout(() => {
                const mailto = `mailto:info@nigelmulgrewplumbing.com?subject=${encodeURIComponent(subject)}&body=${body}`;
                window.location.href = mailto;
                
                alert('PDF saved to your device!\n\nEmail client opening - please attach the PDF file manually.');
            }, 500);
            
            saveData();
        }

        function clearAllData() {
            if (confirm('Are you sure? This will delete all evaluation data and photos!')) {
                if (storageAvailable) {
                    localStorage.removeItem('plumbingEval');
                }
                evaluationData = {};
                roomInstances = {};
                initApp();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (currentPhotoViewing) {
                if (e.key === 'ArrowLeft') changePhoto(-1);
                else if (e.key === 'ArrowRight') changePhoto(1);
                else if (e.key === 'Escape') closePhotoModal();
            }
        });

        window.onload = initApp;
    </script>
</body>
</html>
