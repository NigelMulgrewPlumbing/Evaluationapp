<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Plumbing Eval">
    <title>Plumbing Evaluation - Nigel Mulgrew Plumbing</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1024px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .storage-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 10px 20px;
            border-radius: 4px;
            font-size: 13px;
            display: none;
        }
        
        .storage-warning.show {
            display: block;
        }
        
        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-tab {
            padding: 15px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 14px;
            white-space: nowrap;
            color: #495057;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        
        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }
        
        .tab-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
        }
        
        .tab-delete-btn:hover {
            background: #c82333;
        }
        
        .add-room-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin: 10px 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-room-btn:active {
            background: #218838;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            margin: -20px -20px 20px -20px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rename-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .rename-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .item-number {
            background: #667eea;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .item-title {
            flex: 1;
            font-weight: 500;
            font-size: 15px;
            min-width: 200px;
        }
        
        .condition-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .condition-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .condition-btn.good {
            border-color: #28a745;
            color: #28a745;
        }
        
        .condition-btn.good.active {
            background: #28a745;
            color: white;
        }
        
        .condition-btn.fair {
            border-color: #ffc107;
            color: #ffc107;
        }
        
        .condition-btn.fair.active {
            background: #ffc107;
            color: #000;
        }
        
        .condition-btn.poor {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .condition-btn.poor.active {
            background: #dc3545;
            color: white;
        }
        
        .item-notes {
            margin-top: 10px;
        }
        
        .item-notes textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .photo-section {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .photo-upload {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .photo-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .photo-btn:active {
            background: #5568d3;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .photo-item {
            position: relative;
            padding-top: 100%;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .photo-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        
        .action-buttons {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 15px 20px;
            border-top: 2px solid #dee2e6;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:active {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:active {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:active {
            background: #c82333;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .summary-card h3 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            color: #6c757d;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1001;
        }
        
        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            color: #333;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1001;
        }
        
        .modal-prev {
            left: 20px;
        }
        
        .modal-next {
            right: 20px;
        }
        
        @media (max-width: 768px) {
            .item-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .condition-group {
                width: 100%;
                margin-top: 10px;
            }
            
            .condition-btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Plumbing Evaluation Form</h1>
            <p>Nigel Mulgrew Plumbing, Inc. | Professional Assessment Tool</p>
        </div>
        
        <div class="storage-warning" id="storageWarning">
            ‚ö†Ô∏è <strong>Storage Notice:</strong> Data is saved temporarily. Please export or email your report before closing this app!
        </div>
        
        <div class="nav-tabs" id="navTabs"></div>
        
        <div id="tabsContainer"></div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="saveJSON()">üíæ Save JSON</button>
            <button class="btn btn-success" onclick="emailReport()">üìß Email Report</button>
            <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All</button>
        </div>
    </div>
    
    <div class="modal" id="photoModal">
        <button class="modal-close" onclick="closePhotoModal()">√ó</button>
        <button class="modal-nav modal-prev" onclick="changePhoto(-1)">‚Äπ</button>
        <div class="modal-content">
            <img id="modalImage" src="" alt="Photo">
        </div>
        <button class="modal-nav modal-next" onclick="changePhoto(1)">‚Ä∫</button>
    </div>

    <script>
        const sectionTemplates = {
            bathrooms: {
                title: 'Bathroom',
                emoji: 'üöΩ',
                canAddMultiple: true,
                items: [
                    'Toilet flush', 'Toilet leaks', 'Toilet wobbles', 'Toilet wax ring',
                    'Sink faucet operation', 'Sink drain', 'Sink leaks', 'Sink trap',
                    'Shower/tub faucet', 'Shower/tub drain', 'Shower/tub leaks', 'Shower head',
                    'Tub spout', 'Tub caulking', 'Floor drain', 'Exhaust fan',
                    'Water pressure', 'Hot water temp', 'Angle stops', 'Supply lines',
                    'Tile/grout condition', 'Caulking', 'Water damage', 'Ventilation',
                    'Accessibility', 'Fixtures age', 'Overall bathroom'
                ]
            },
            kitchen: {
                title: 'Kitchen',
                emoji: 'üç≥',
                canAddMultiple: true,
                items: [
                    'Kitchen sink faucet', 'Kitchen sink drain', 'Kitchen sink leaks',
                    'Garbage disposal', 'Dishwasher connection', 'Dishwasher drain',
                    'Ice maker line', 'Pot filler', 'Kitchen sprayer',
                    'Angle stops', 'Supply lines', 'Drain pipes',
                    'Air gap', 'Soap dispenser', 'Water filter',
                    'Caulking', 'Overall kitchen'
                ]
            },
            laundry: {
                title: 'Laundry',
                emoji: 'üß∫',
                canAddMultiple: false,
                items: [
                    'Washer hot valve', 'Washer cold valve', 'Washer drain',
                    'Washer box', 'Hoses condition', 'Laundry sink faucet',
                    'Laundry sink drain', 'Floor drain', 'Venting',
                    'Water pressure', 'Shut-off valves', 'Overall laundry'
                ]
            },
            basement: {
                title: 'Basement/Utility',
                emoji: 'üîß',
                canAddMultiple: false,
                items: [
                    'Main shut-off valve', 'Pressure regulator', 'Water heater',
                    'Water heater age', 'Water heater venting', 'TPR valve',
                    'Drain pan', 'Expansion tank', 'Gas lines',
                    'Sump pump', 'Ejector pump', 'Floor drains',
                    'Cleanouts', 'Pipe insulation', 'Pipe condition',
                    'Foundation leaks', 'Sewer line', 'Overall basement'
                ]
            },
            garage: {
                title: 'Garage/Yard',
                emoji: 'üè°',
                canAddMultiple: false,
                items: [
                    'Hose bibs', 'Hose bib leaks', 'Sprinkler system',
                    'Sprinkler valves', 'Backflow preventer', 'Yard drains',
                    'Sewer cleanout', 'Water meter', 'Main line',
                    'Overall exterior'
                ]
            },
            general: {
                title: 'General',
                emoji: 'üìã',
                canAddMultiple: false,
                items: [
                    'Water quality', 'Water odor', 'Water color',
                    'Overall pressure', 'Pipe material', 'Visible corrosion',
                    'Signs of leaks', 'Water stains', 'Mold/mildew',
                    'Code compliance', 'Safety issues', 'Overall assessment'
                ]
            },
            other: {
                title: 'Other',
                emoji: 'üìù',
                canAddMultiple: false,
                items: [
                    'Additional item 1', 'Additional item 2', 'Additional item 3',
                    'Additional item 4', 'Additional item 5', 'Additional notes'
                ]
            }
        };

        let currentTab = 'bathrooms-0';
        let evaluationData = {};
        let roomInstances = {};
        let currentPhotoViewing = null;
        let storageAvailable = false;

        function checkStorage() {
            try {
                const testKey = '__storage_test__';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                storageAvailable = true;
                return true;
            } catch (e) {
                storageAvailable = false;
                document.getElementById('storageWarning').classList.add('show');
                console.warn('localStorage not available:', e);
                return false;
            }
        }

        function initApp() {
            checkStorage();
            
            // Initialize with one instance of each room type
            Object.keys(sectionTemplates).forEach(type => {
                if (!roomInstances[type]) {
                    roomInstances[type] = [];
                }
                if (roomInstances[type].length === 0) {
                    addRoom(type, false);
                }
            });

            if (storageAvailable) {
                loadData();
            }

            renderTabs();
            renderContent();
        }

        function generateRoomId(type) {
            const count = roomInstances[type].length;
            return `${type}-${count}`;
        }

        function addRoom(type, shouldSave = true) {
            const template = sectionTemplates[type];
            const roomId = generateRoomId(type);
            
            const defaultName = template.canAddMultiple 
                ? `${template.title} ${roomInstances[type].length + 1}`
                : template.title;

            roomInstances[type].push({
                id: roomId,
                name: defaultName,
                type: type
            });

            evaluationData[roomId] = {
                type: type,
                name: defaultName,
                items: {},
                photos: []
            };

            template.items.forEach((item, index) => {
                evaluationData[roomId].items[index] = {
                    title: item,
                    condition: null,
                    notes: ''
                };
            });

            currentTab = roomId;

            if (shouldSave) {
                saveDataDebounced();
                renderTabs();
                renderContent();
            }
        }

        function deleteRoom(roomId) {
            const roomData = evaluationData[roomId];
            if (!roomData) return;

            const type = roomData.type;
            const template = sectionTemplates[type];

            if (!template.canAddMultiple) {
                alert(`Cannot delete ${template.title} - only one allowed.`);
                return;
            }

            if (!confirm(`Delete ${roomData.name}?`)) return;

            // Remove from instances
            roomInstances[type] = roomInstances[type].filter(r => r.id !== roomId);
            
            // Delete data
            delete evaluationData[roomId];

            // Switch to another tab
            if (currentTab === roomId) {
                const allRoomIds = getAllRoomIds();
                currentTab = allRoomIds[0] || 'summary';
            }

            saveDataDebounced();
            renderTabs();
            renderContent();
        }

        function renameRoom(roomId) {
            const roomData = evaluationData[roomId];
            if (!roomData) return;

            const newName = prompt('Enter new name:', roomData.name);
            if (newName && newName.trim()) {
                roomData.name = newName.trim();
                
                // Update in instances
                const type = roomData.type;
                const instance = roomInstances[type].find(r => r.id === roomId);
                if (instance) {
                    instance.name = newName.trim();
                }

                saveDataDebounced();
                renderTabs();
                renderContent();
            }
        }

        function getAllRoomIds() {
            const ids = [];
            Object.keys(roomInstances).forEach(type => {
                roomInstances[type].forEach(room => {
                    ids.push(room.id);
                });
            });
            return ids;
        }

        function renderTabs() {
            const navTabs = document.getElementById('navTabs');
            navTabs.innerHTML = '';

            // Add tabs for each room instance
            Object.keys(sectionTemplates).forEach(type => {
                const template = sectionTemplates[type];
                
                roomInstances[type].forEach(room => {
                    const button = document.createElement('button');
                    button.className = `nav-tab ${room.id === currentTab ? 'active' : ''}`;
                    button.onclick = () => switchTab(room.id);
                    
                    const label = document.createElement('span');
                    label.textContent = `${template.emoji} ${room.name}`;
                    button.appendChild(label);

                    if (template.canAddMultiple && roomInstances[type].length > 1) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'tab-delete-btn';
                        deleteBtn.textContent = '√ó';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            deleteRoom(room.id);
                        };
                        button.appendChild(deleteBtn);
                    }

                    navTabs.appendChild(button);
                });

                // Add "+" button for types that can have multiples
                if (template.canAddMultiple) {
                    const addBtn = document.createElement('button');
                    addBtn.className = 'add-room-btn';
                    addBtn.innerHTML = `+ Add ${template.title}`;
                    addBtn.onclick = () => addRoom(type);
                    navTabs.appendChild(addBtn);
                }
            });

            // Add summary tab
            const summaryBtn = document.createElement('button');
            summaryBtn.className = `nav-tab ${currentTab === 'summary' ? 'active' : ''}`;
            summaryBtn.textContent = 'üìä Summary';
            summaryBtn.onclick = () => switchTab('summary');
            navTabs.appendChild(summaryBtn);
        }

        function switchTab(tab) {
            currentTab = tab;
            renderTabs();
            renderContent();
        }

        function renderContent() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';

            if (currentTab === 'summary') {
                container.innerHTML = renderSummary();
                return;
            }

            const roomData = evaluationData[currentTab];
            if (!roomData) return;

            const template = sectionTemplates[roomData.type];

            let html = `
                <div class="tab-content active">
                    <div class="section-header">
                        <span>${template.emoji} ${roomData.name}</span>
                        <button class="rename-btn" onclick="renameRoom('${currentTab}')">‚úèÔ∏è Rename</button>
                    </div>
            `;

            template.items.forEach((item, index) => {
                const itemData = roomData.items[index];
                html += `
                    <div class="item">
                        <div class="item-header">
                            <div class="item-number">${index + 1}</div>
                            <div class="item-title">${item}</div>
                            <div class="condition-group">
                                <button class="condition-btn good ${itemData.condition === 'good' ? 'active' : ''}" 
                                        onclick="setCondition('${currentTab}', ${index}, 'good')">‚úì Good</button>
                                <button class="condition-btn fair ${itemData.condition === 'fair' ? 'active' : ''}" 
                                        onclick="setCondition('${currentTab}', ${index}, 'fair')">! Fair</button>
                                <button class="condition-btn poor ${itemData.condition === 'poor' ? 'active' : ''}" 
                                        onclick="setCondition('${currentTab}', ${index}, 'poor')">‚úó Poor</button>
                            </div>
                        </div>
                        <div class="item-notes">
                            <textarea placeholder="Add notes..." 
                                      onchange="setNotes('${currentTab}', ${index}, this.value)"
                                      onblur="saveDataDebounced()">${itemData.notes}</textarea>
                        </div>
                    </div>
                `;
            });

            html += `
                    <div class="photo-section">
                        <div class="photo-upload">
                            <input type="file" id="photoInput_${currentTab}" accept="image/*" 
                                   capture="environment" style="display:none" 
                                   onchange="handlePhotoUpload('${currentTab}', event)" multiple>
                            <button class="photo-btn" onclick="document.getElementById('photoInput_${currentTab}').click()">
                                üì∑ Add Photos
                            </button>
                            <span style="font-size:12px;color:#6c757d;">${roomData.photos.length} photos</span>
                        </div>
                        <div class="photo-grid" id="photoGrid_${currentTab}">
                            ${renderPhotos(currentTab)}
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function setCondition(roomId, index, condition) {
            evaluationData[roomId].items[index].condition = condition;
            saveDataDebounced();
            renderContent();
        }

        function setNotes(roomId, index, notes) {
            evaluationData[roomId].items[index].notes = notes;
        }

        let saveTimeout;
        function saveDataDebounced() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 500);
        }

        function saveData() {
            if (!storageAvailable) {
                console.warn('Storage not available, data not saved');
                return;
            }
            
            try {
                const dataToSave = {
                    version: 2,
                    timestamp: new Date().toISOString(),
                    roomInstances: roomInstances,
                    data: evaluationData
                };
                localStorage.setItem('plumbingEval', JSON.stringify(dataToSave));
            } catch (e) {
                console.error('Error saving data:', e);
                document.getElementById('storageWarning').classList.add('show');
            }
        }

        function loadData() {
            try {
                const saved = localStorage.getItem('plumbingEval');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (confirm('Found saved data from ' + new Date(parsed.timestamp).toLocaleString() + '. Restore it?')) {
                        if (parsed.version === 2) {
                            roomInstances = parsed.roomInstances;
                            evaluationData = parsed.data;
                        } else {
                            // Migrate old data
                            alert('Converting old data format...');
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        async function handlePhotoUpload(roomId, event) {
            const files = Array.from(event.target.files);
            
            for (const file of files) {
                try {
                    const compressed = await compressImage(file);
                    evaluationData[roomId].photos.push(compressed);
                } catch (e) {
                    console.error('Error processing photo:', e);
                    alert('Error processing photo. It may be too large.');
                }
            }
            
            saveDataDebounced();
            renderContent();
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 1200;
                        
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function renderPhotos(roomId) {
            const photos = evaluationData[roomId].photos;
            return photos.map((photo, index) => `
                <div class="photo-item" onclick="viewPhoto('${roomId}', ${index})">
                    <img src="${photo}" alt="Photo ${index + 1}">
                    <button class="photo-delete" onclick="event.stopPropagation(); deletePhoto('${roomId}', ${index})">√ó</button>
                </div>
            `).join('');
        }

        function deletePhoto(roomId, index) {
            if (confirm('Delete this photo?')) {
                evaluationData[roomId].photos.splice(index, 1);
                saveDataDebounced();
                renderContent();
            }
        }

        function viewPhoto(roomId, index) {
            currentPhotoViewing = { roomId, index };
            const modal = document.getElementById('photoModal');
            const img = document.getElementById('modalImage');
            img.src = evaluationData[roomId].photos[index];
            modal.classList.add('active');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('active');
            currentPhotoViewing = null;
        }

        function changePhoto(direction) {
            if (!currentPhotoViewing) return;
            
            const { roomId, index } = currentPhotoViewing;
            const photos = evaluationData[roomId].photos;
            let newIndex = index + direction;
            
            if (newIndex < 0) newIndex = photos.length - 1;
            if (newIndex >= photos.length) newIndex = 0;
            
            viewPhoto(roomId, newIndex);
        }

        function renderSummary() {
            let totalItems = 0;
            let goodCount = 0;
            let fairCount = 0;
            let poorCount = 0;
            let notEvaluated = 0;
            let totalPhotos = 0;

            Object.values(evaluationData).forEach(roomData => {
                const items = roomData.items;
                Object.values(items).forEach(item => {
                    totalItems++;
                    if (item.condition === 'good') goodCount++;
                    else if (item.condition === 'fair') fairCount++;
                    else if (item.condition === 'poor') poorCount++;
                    else notEvaluated++;
                });
                totalPhotos += roomData.photos.length;
            });

            return `
                <div class="tab-content active">
                    <div class="section-header">üìä Evaluation Summary</div>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <h3>${totalItems}</h3>
                            <p>Total Items</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="color:#28a745">${goodCount}</h3>
                            <p>Good Condition</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="color:#ffc107">${fairCount}</h3>
                            <p>Fair Condition</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="color:#dc3545">${poorCount}</h3>
                            <p>Poor Condition</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="color:#6c757d">${notEvaluated}</h3>
                            <p>Not Evaluated</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="color:#667eea">${totalPhotos}</h3>
                            <p>Photos Taken</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function saveJSON() {
            const dataStr = JSON.stringify({
                roomInstances,
                evaluationData
            }, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `plumbing-eval-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function emailReport() {
            let report = 'PLUMBING EVALUATION REPORT\n';
            report += 'Date: ' + new Date().toLocaleString() + '\n\n';
            
            let issuesFound = [];
            
            Object.values(evaluationData).forEach(roomData => {
                Object.entries(roomData.items).forEach(([index, item]) => {
                    if (item.condition === 'fair' || item.condition === 'poor') {
                        let issue = `${roomData.name} - ${item.title}: ${item.condition.toUpperCase()}`;
                        if (item.notes) {
                            issue += ` (${item.notes})`;
                        }
                        issuesFound.push(issue);
                    }
                });
            });
            
            if (issuesFound.length > 0) {
                report += 'ISSUES FOUND:\n\n';
                issuesFound.forEach((issue, i) => {
                    report += `${i + 1}. ${issue}\n`;
                });
            } else {
                report += 'No significant issues found.\n';
            }
            
            report += '\n\nFor full details, please download the JSON file.';
            
            const subject = 'Plumbing Evaluation - ' + new Date().toLocaleDateString();
            const body = encodeURIComponent(report);
            const mailto = `mailto:info@nigelmulgrewplumbing.com?subject=${encodeURIComponent(subject)}&body=${body}`;
            
            window.location.href = mailto;
            
            alert('Opening email client...\n\nIf email doesn\'t open, please export the JSON file and attach it to your email manually.');
            
            saveData();
        }

        function clearAllData() {
            if (confirm('Are you sure? This will delete all evaluation data and photos!')) {
                if (storageAvailable) {
                    localStorage.removeItem('plumbingEval');
                }
                evaluationData = {};
                roomInstances = {};
                initApp();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (currentPhotoViewing) {
                if (e.key === 'ArrowLeft') changePhoto(-1);
                else if (e.key === 'ArrowRight') changePhoto(1);
                else if (e.key === 'Escape') closePhotoModal();
            }
        });

        window.onload = initApp;
    </script>
</body>
</html>
